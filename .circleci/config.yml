version: 2.1

orbs:
  node: circleci/node@5.1.0
  rust: circleci/rust@1.6.0
  secops: apollo/circleci-secops-orb@2.0.7

jobs:
  # Unfortunately cimg/node doesn't tag its images with major only, you have to specify a minor version.
  # We wouldn't need this job if it did, we could just use node/test with a matrix of node major versions.
  Test:
    description: "Run tests for a specific Node.js version"
    parameters:
      node-version:
        type: string
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - node/install:
          node-version: << parameters.node-version >>
      # node v14 defaults to npm 6, which is too old for our package-lock.json
      # should be able to remove this step when we drop node v14
      - run: npm install -g npm@9
      - node/install-packages
      - setup_rust
      - run:
          name: Run tests
          command: npm run test:ci
      - run:
          name: Upload coverage
          command: npm run coverage:upload
      - store_test_results:
          path: junit.xml
  Check Hints Code Doc:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - node/install:
          node-version: "20"
      - setup_rust
      - run:
          name: Install deps and build
          command: npm ci && npm run compile
      - run:
          name: Check Hints Code Doc
          command: npm run hints-doc:check
  Lint Rust:
    description: "Lint Rust code"
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - setup_rust
      - run:
          name: Clippy
          command: |
            cd internals-js/wasm
            cargo clippy
      - save_cache:
          key: rust-{{ checksum "internals-js/wasm/Cargo.toml" }}-{{ checksum "internals-js/wasm/Cargo.lock" }}
          paths:
            - ~/.cargo/
  Check Rust Format:
    description: "Check Rust code formatting"
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - rust/install:
          version: nightly
      - run:
          name: Rustfmt
          command: |
            cd internals-js/wasm
            cargo +nightly fmt -- --check

workflows:
  Build:
    jobs:
      - Test:
          name: Test - Node.js v<< matrix.node-version >>
          matrix:
            parameters:
              node-version:
                - "14"
                - "16"
                - "18"
                - "20"
      - node/run:
          name: Check Error Code Doc
          npm-run: error-code-doc:check
      - node/run:
          name: Check GraphQL Types
          npm-run: codegen:check
      - Check Hints Code Doc
      - node/run:
          name: Check Spelling
          npm-run: spell:check
      - node/run:
          name: Check Prettier (tests)
          npm-run: prettier:check
      - Lint Rust
  security-scans:
    jobs:
      - secops/gitleaks:
          context:
            - platform-docker-ro
            - github-orb
            - secops-oidc
          git-base-revision: <<#pipeline.git.base_revision>><<pipeline.git.base_revision>><</pipeline.git.base_revision >>
          git-revision: << pipeline.git.revision >>
      - secops/semgrep:
          context:
            - secops-oidc
            - github-orb
          git-base-revision: <<#pipeline.git.base_revision>><<pipeline.git.base_revision>><</pipeline.git.base_revision >>
commands:
  setup_rust:
    steps:
      - rust/install:
          version: stable
      - restore_cache:
          keys:
            - rust-{{ checksum "internals-js/wasm/Cargo.toml" }}-{{ checksum "internals-js/wasm/Cargo.lock" }}
            - rust-{{ checksum "internals-js/wasm/Cargo.toml" }}
            - rust